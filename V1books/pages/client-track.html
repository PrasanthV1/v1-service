<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track Requests - V1 Services</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .search-section {
      background-color: var(--secondary-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .request-detail {
      background-color: var(--secondary-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 20px;
    }

    .request-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .request-id {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent-color);
      font-family: 'Courier New', monospace;
    }

    .tracking-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-item {
      background-color: var(--primary-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 15px;
    }

    .info-label {
      color: var(--text-secondary);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .info-value {
      color: var(--text-primary);
      font-size: 1.1rem;
      font-weight: 600;
    }

    .timeline {
      position: relative;
      padding: 20px 0;
    }

    .timeline-item {
      position: relative;
      padding-left: 40px;
      margin-bottom: 30px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 5px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: var(--border-color);
      border: 3px solid var(--primary-color);
    }

    .timeline-item.active::before {
      background-color: var(--accent-color);
      box-shadow: 0 0 0 4px rgba(225, 6, 0, 0.2);
    }

    .timeline-item::after {
      content: '';
      position: absolute;
      left: 15px;
      top: 25px;
      width: 2px;
      height: calc(100% + 10px);
      background-color: var(--border-color);
    }

    .timeline-item:last-child::after {
      display: none;
    }

    .timeline-content h4 {
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .timeline-content p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .search-section {
        grid-template-columns: 1fr;
      }

      .request-header {
        flex-direction: column;
        gap: 15px;
      }

      .tracking-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Spinner -->
  <div id="loader" class="loader">
    <div class="spinner"></div>
    <div class="spinner-text">Loading requests...</div>
  </div>

  <!-- Navigation -->
  <nav>
    <div class="navbar container">
      <div class="navbar-brand">
        <div class="logo-container" style="margin-right: 0; gap: 8px;">
          <img src="../images/logo.png" alt="V1 Services Logo" class="logo-img-small" style="height: 35px;">
          <span>V1 Services</span>
        </div>
      </div>
      <ul class="navbar-nav">
        <li><a href="client-dashboard.html">Dashboard</a></li>
        <li><a href="client-request.html">New Request</a></li>
        <li class="active"><a href="client-track.html">Track Requests</a></li>
        <li><a href="client-help.html">Help & Support</a></li>
      </ul>
      <div class="user-menu">
        <div class="user-info">
          <div class="user-avatar" id="userInitial">C</div>
          <small style="color: var(--text-secondary);">Client</small>
        </div>
        <button class="btn btn-secondary btn-small" onclick="logoutUser()">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container">
    <div style="margin: 40px 0;">
      <h1>Track Your Requests</h1>
      <p style="color: var(--text-secondary); margin-top: 8px;">View detailed status of all your submitted requests</p>
    </div>

    <div class="search-section">
      <div class="form-group">
        <label for="searchTracking">Search by Tracking ID</label>
        <input 
          type="text" 
          id="searchTracking" 
          placeholder="e.g., V1-102938" 
        >
      </div>
      <div class="form-group">
        <label for="filterService">Filter by Service</label>
        <select id="filterService">
          <option value="">All Services</option>
          <option value="GST">GST Returns</option>
          <option value="Income Tax">Income Tax</option>
          <option value="TDS">TDS Compliance</option>
          <option value="Registrations">Registrations</option>
          <option value="Compliance">Compliance Audit</option>
          <option value="Other">Other Services</option>
        </select>
      </div>
    </div>

    <div id="requestsContainer">
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <h3>No requests found</h3>
        <p style="color: var(--text-secondary); margin-top: 10px;">
          <a href="client-request.html" style="color: var(--accent-color); font-weight: 600;">Submit your first request</a>
        </p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer style="margin-top: 60px;">
    <div class="footer-content">
      <div class="footer-section">
        <h4>Need Help?</h4>
        <ul>
          <li><a href="https://wa.me/919360522383" target="_blank">WhatsApp Support</a></li>
          <li><a href="mailto:support@v1books.com">Email Support</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 V1Books. All rights reserved.</p>
    </div>
  </footer>

  <!-- WhatsApp Button -->
  <a href="https://wa.me/919360522383" target="_blank" class="whatsapp-btn" title="Chat with us on WhatsApp">
    üí¨
  </a>

  <script src="../js/utils.js"></script>
  <script src="../js/api.js"></script>
  <script>
    // Check authentication
    requireAuth();

    const currentUser = Session.getCurrentUser();
    document.getElementById('userInitial').textContent = currentUser.email.charAt(0).toUpperCase();

    let allRequests = [];

    /**
     * Load all client requests
     */
    async function loadRequests() {
      showLoading(true);
      try {
        allRequests = await github.getClientRequests(currentUser.email);
        displayRequests(allRequests);
        showLoading(false);
      } catch (error) {
        showLoading(false);
        showNotification('Failed to load requests', 'danger');
        console.error('Error:', error);
      }
    }

    /**
     * Display requests with filters applied
     */
    function displayRequests(requests) {
      const container = document.getElementById('requestsContainer');

      if (requests.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <h3>No requests found</h3>
            <p style="color: var(--text-secondary); margin-top: 10px;">
              <a href="client-request.html" style="color: var(--accent-color); font-weight: 600;">Submit your first request</a>
            </p>
          </div>
        `;
        return;
      }

      container.innerHTML = requests.map(req => `
        <div class="request-detail">
          <div class="request-header">
            <div class="request-id">${req.trackingId}</div>
            <span class="status-badge status-${req.status.toLowerCase().replace(' ', '-')}">${req.status}</span>
          </div>

          <div class="tracking-info">
            <div class="info-item">
              <div class="info-label">Service</div>
              <div class="info-value">${req.service}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Period</div>
              <div class="info-value">${req.period}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Assigned Auditor</div>
              <div class="info-value">${req.assignedAuditor || '‚è≥ Pending'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Submitted On</div>
              <div class="info-value">${formatDate(req.createdAt)}</div>
            </div>
          </div>

          <div style="margin-top: 20px;">
            <h4 style="margin-bottom: 15px;">Request Details</h4>
            <p style="color: var(--text-secondary); line-height: 1.8;">${req.description}</p>
          </div>

          <div style="margin-top: 30px;">
            <h4 style="margin-bottom: 20px;">Status Timeline</h4>
            <div class="timeline">
              <div class="timeline-item ${['Submitted', 'Assigned', 'In Progress', 'Completed', 'Rejected'].includes(req.status) ? 'active' : ''}">
                <div class="timeline-content">
                  <h4>Request Submitted</h4>
                  <p>${formatDate(req.createdAt)}</p>
                </div>
              </div>
              <div class="timeline-item ${['Assigned', 'In Progress', 'Completed', 'Rejected'].includes(req.status) ? 'active' : ''}">
                <div class="timeline-content">
                  <h4>Auditor Assigned</h4>
                  <p>${req.assignedAuditor ? `Assigned to ${req.assignedAuditor}` : 'Awaiting assignment'}</p>
                </div>
              </div>
              <div class="timeline-item ${['In Progress', 'Completed'].includes(req.status) ? 'active' : ''}">
                <div class="timeline-content">
                  <h4>In Progress</h4>
                  <p>Auditor is reviewing your documents</p>
                </div>
              </div>
              <div class="timeline-item ${req.status === 'Completed' ? 'active' : ''}">
                <div class="timeline-content">
                  <h4>Completed</h4>
                  <p>Ready for download and submission</p>
                </div>
              </div>
            </div>
          </div>

          ${req.lastNotes ? `
            <div style="margin-top: 20px; padding: 15px; background-color: var(--primary-color); border-left: 3px solid var(--accent-color); border-radius: 4px;">
              <strong style="color: var(--accent-color);">Latest Update:</strong>
              <p style="margin-top: 8px; color: var(--text-secondary);">${req.lastNotes}</p>
              <small style="color: var(--text-secondary);">Updated: ${formatDate(req.lastUpdated)}</small>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    /**
     * Filter and search requests
     */
    function filterRequests() {
      const searchValue = document.getElementById('searchTracking').value.toUpperCase();
      const serviceValue = document.getElementById('filterService').value;

      let filtered = allRequests;

      if (searchValue) {
        filtered = filtered.filter(r => r.trackingId.includes(searchValue));
      }

      if (serviceValue) {
        filtered = filtered.filter(r => r.service === serviceValue);
      }

      displayRequests(filtered);
    }

    // Event listeners
    document.getElementById('searchTracking').addEventListener('input', filterRequests);
    document.getElementById('filterService').addEventListener('change', filterRequests);

    /**
     * Logout handler
     */
    function logoutUser() {
      if (confirm('Are you sure you want to logout?')) {
        Session.logout();
      }
    }

    // Load requests on page load
    loadRequests();
  </script>
</body>
</html>
