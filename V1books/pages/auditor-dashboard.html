<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auditor Dashboard - V1 Services</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background-color: var(--secondary-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      border-color: var(--accent-color);
      transform: translateY(-3px);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-color);
      margin: 10px 0;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .welcome-section {
      background-color: var(--secondary-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .table-container {
      overflow-x: auto;
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Loading Spinner -->
  <div id="loader" class="loader">
    <div class="spinner"></div>
    <div class="spinner-text">Loading dashboard...</div>
  </div>

  <!-- Navigation -->
  <nav>
    <div class="navbar container">
      <div class="navbar-brand">
        <div class="logo-container" style="margin-right: 0; gap: 8px;">
          <img src="../images/logo.png" alt="V1 Services Logo" class="logo-img-small" style="height: 35px;">
          <span>V1 Services</span>
        </div>
      </div>
      <ul class="navbar-nav">
        <li class="active"><a href="auditor-dashboard.html">Dashboard</a></li>
        <li><a href="auditor-requests.html">My Requests</a></li>
      </ul>
      <div class="user-menu">
        <div class="user-info">
          <div class="user-avatar" id="userInitial">A</div>
          <div>
            <div style="font-weight: 600;" id="userEmail">auditor@email.com</div>
            <small style="color: var(--text-secondary);">Auditor</small>
          </div>
        </div>
        <button class="btn btn-secondary btn-small" onclick="logoutUser()">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="welcome-section">
      <h2 id="welcomeMessage">Welcome back!</h2>
      <p style="margin: 8px 0 0; color: var(--text-secondary);">Review and process client requests</p>
    </div>

    <div class="dashboard-grid">
      <div class="stat-card">
        <div style="font-size: 1.8rem;">üìã</div>
        <div class="stat-value" id="assignedRequests">0</div>
        <div class="stat-label">Assigned to Me</div>
      </div>
      <div class="stat-card">
        <div style="font-size: 1.8rem;">‚è≥</div>
        <div class="stat-value" id="pendingRequests">0</div>
        <div class="stat-label">Pending Work</div>
      </div>
      <div class="stat-card">
        <div style="font-size: 1.8rem;">üîÑ</div>
        <div class="stat-value" id="inProgressRequests">0</div>
        <div class="stat-label">In Progress</div>
      </div>
      <div class="stat-card">
        <div style="font-size: 1.8rem;">‚úÖ</div>
        <div class="stat-value" id="completedRequests">0</div>
        <div class="stat-label">Completed</div>
      </div>
    </div>

    <div style="margin-top: 40px;">
      <h2 style="margin-bottom: 20px;">Your Assigned Requests</h2>
      <div class="card">
        <div class="table-container">
          <table id="requestsTable">
            <thead>
              <tr>
                <th>Tracking ID</th>
                <th>Client Email</th>
                <th>Service</th>
                <th>Period</th>
                <th>Status</th>
                <th>Submitted</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 30px;">
                  Loading requests...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer style="margin-top: 60px;">
    <div class="footer-content">
      <div class="footer-section">
        <h4>V1 Services</h4>
        <p>Professional Accounts & Finance solutions.</p>
      </div>
      <div class="footer-section">
        <h4>Support</h4>
        <ul>
          <li><a href="mailto:support@v1books.com">Email: support@v1books.com</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 V1Books. All rights reserved.</p>
    </div>
  </footer>

  <script src="../js/utils.js"></script>
  <script src="../js/api.js"></script>
  <script>
    // Check authentication
    requireAuth();

    const currentUser = Session.getCurrentUser();

    // Verify user is auditor
    if (currentUser.role !== 'auditor') {
      alert('Access denied. Auditors only.');
      Session.logout();
    }

    // Set user info
    document.getElementById('userEmail').textContent = currentUser.email;
    document.getElementById('userInitial').textContent = currentUser.email.charAt(0).toUpperCase();
    document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentUser.email.split('@')[0]}!`;

    /**
     * Load auditor's assigned requests
     */
    async function loadAuditorRequests() {
      showLoading(true);
      try {
        const requests = await github.getAuditorRequests(currentUser.email);
        
        // Calculate stats
        const stats = {
          total: requests.length,
          pending: requests.filter(r => r.status === 'Assigned').length,
          inProgress: requests.filter(r => r.status === 'In Progress').length,
          completed: requests.filter(r => r.status === 'Completed').length
        };

        // Update stat cards
        document.getElementById('assignedRequests').textContent = stats.total;
        document.getElementById('pendingRequests').textContent = stats.pending;
        document.getElementById('inProgressRequests').textContent = stats.inProgress;
        document.getElementById('completedRequests').textContent = stats.completed;

        // Load requests table
        const tbody = document.querySelector('#requestsTable tbody');
        
        if (requests.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 30px;">
                No requests assigned yet. Check back soon!
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = requests.map(req => `
            <tr>
              <td style="font-weight: 600; color: var(--accent-color);">${req.trackingId}</td>
              <td>${req.clientEmail}</td>
              <td>${req.service}</td>
              <td>${req.period}</td>
              <td><span class="status-badge status-${req.status.toLowerCase().replace(' ', '-')}">${req.status}</span></td>
              <td>${formatDate(req.createdAt)}</td>
              <td><a href="auditor-requests.html?id=${req.trackingId}" style="color: var(--accent-color); font-weight: 600;">Process</a></td>
            </tr>
          `).join('');
        }

        showLoading(false);
      } catch (error) {
        showLoading(false);
        showNotification('Failed to load requests', 'danger');
        console.error('Error:', error);
      }
    }

    /**
     * Logout handler
     */
    function logoutUser() {
      if (confirm('Are you sure you want to logout?')) {
        Session.logout();
      }
    }

    // Load data on page load
    loadAuditorRequests();
  </script>
</body>
</html>
